<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON Fixer for ArcGIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js untuk OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-pink': '#fff0f5',   /* Latar belakang terang */
                        'brand-navy': '#2c2c34',   /* Warna gelap/teks */
                        'brand-gold': '#d4af37',   /* Aksen emas */
                        'brand-red': '#dc2626',    /* Merah terang */
                        'brand-grey': '#e5e7eb',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .json-preview { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body class="bg-brand-pink min-h-screen p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-brand-grey">
        
        <!-- Header: Menggunakan Merah Terang (Bright) -->
        <div class="bg-brand-red p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shadow-md">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-brand-gold"></i> <span id="appTitle">GeoJSON Fixer</span>
                </h1>
                <p class="text-red-100 mt-1 text-sm md:text-base" id="appSubtitle">Ubah format GeometryCollection menjadi FeatureCollection (ArcGIS Ready)</p>
            </div>
            
            <!-- Language Toggle: Navy & White -->
            <div class="bg-red-800 rounded-lg p-1 flex shrink-0">
                <button onclick="setLang('id')" id="btn-id" class="px-3 py-1 rounded text-sm font-bold bg-white text-brand-red transition shadow-sm">ID</button>
                <button onclick="setLang('en')" id="btn-en" class="px-3 py-1 rounded text-sm font-bold text-red-200 hover:text-white transition">EN</button>
            </div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Kolom Input -->
            <div class="flex flex-col h-full relative">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-2 gap-2">
                    <label class="font-bold text-brand-navy" id="labelInput">Data Mentah (Input)</label>
                    
                    <div class="flex gap-2 items-center">
                        <!-- Tombol Warning (Gold) -->
                        <button onclick="showOcrInfo()" class="text-amber-500 hover:text-amber-600 transition p-1" title="Info OCR">
                            <i class="fa-solid fa-triangle-exclamation fa-lg"></i>
                        </button>

                        <!-- Tombol Scan -->
                        <button onclick="document.getElementById('imgUpload').click()" class="text-xs bg-brand-navy hover:bg-slate-700 text-white px-3 py-1.5 rounded flex items-center gap-1 transition shadow-sm">
                            <i class="fa-solid fa-camera"></i> <span id="btnScan">Scan Gambar (OCR)</span>
                        </button>
                        
                        <button onclick="loadSample()" class="text-xs text-brand-red font-semibold hover:underline" id="btnSample">Isi Contoh</button>
                    </div>
                    <!-- Hidden File Input -->
                    <input type="file" id="imgUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                </div>

                <div class="relative w-full h-64 md:h-96">
                    <!-- Progress Bar OCR -->
                    <div id="ocrProgress" class="hidden absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center text-brand-navy">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-brand-red"></i>
                        <span class="font-bold animate-pulse" id="ocrStatus">Membaca gambar...</span>
                        <div class="w-1/2 h-2 bg-gray-200 rounded-full mt-2 overflow-hidden">
                            <div id="progressBar" class="h-full bg-brand-red w-0 transition-all duration-300"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 px-4 text-center" id="ocrWarning">Akurasi tergantung kualitas gambar.</p>
                    </div>

                    <textarea id="inputJson" class="json-preview w-full h-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-brand-red focus:outline-none text-xs bg-gray-50 resize-none text-slate-700" placeholder="Paste kode JSON dari aplikasi Anda di sini..."></textarea>
                </div>
                
                <div class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                    <i class="fa-solid fa-circle-info text-brand-navy"></i> <span id="infoText">Paste teks JSON atau upload screenshot yang berisi kode.</span>
                </div>
            </div>

            <!-- Kolom Output -->
            <div class="flex flex-col h-full relative">
                <label class="font-bold text-brand-navy mb-2" id="labelOutput">Hasil Perbaikan (ArcGIS Ready)</label>
                
                <!-- Overlay Belum Di-convert -->
                <div id="placeholderOverlay" class="absolute inset-0 top-8 bg-brand-pink/50 backdrop-blur-sm flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg z-10 text-gray-400">
                    <i class="fa-solid fa-arrow-left text-3xl mb-2 md:hidden text-brand-red/50"></i>
                    <i class="fa-solid fa-arrow-right text-3xl mb-2 hidden md:block text-brand-red/50"></i>
                    <p id="overlayText" class="font-medium">Klik tombol Perbaiki di bawah</p>
                </div>

                <textarea id="outputJson" readonly class="json-preview w-full h-64 md:h-96 p-4 border border-green-200 rounded-lg bg-green-50 text-xs resize-none focus:outline-none text-gray-700" placeholder="..."></textarea>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="bg-gray-50 p-6 border-t border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4">
            
            <!-- Tombol Utama: Merah Terang -->
            <button onclick="convertData()" class="w-full md:w-auto px-6 py-3 bg-brand-red hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105 flex items-center justify-center gap-2">
                <i class="fa-solid fa-wand-magic-sparkles text-brand-gold"></i> <span id="btnConvert">Perbaiki untuk ArcGIS</span>
            </button>

            <div class="flex gap-3 w-full md:w-auto">
                <button id="btnCopy" onclick="copyToClipboard()" disabled class="flex-1 md:flex-none px-4 py-2 border border-brand-navy text-brand-navy font-semibold rounded-lg hover:bg-white hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition">
                    <i class="fa-regular fa-copy"></i> <span id="btnCopyText">Copy</span>
                </button>
                <!-- Tombol Download: Navy -->
                <button id="btnDownload" onclick="downloadFile()" disabled class="flex-1 md:flex-none px-4 py-2 bg-brand-navy hover:bg-slate-800 text-white font-semibold rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-download text-brand-gold"></i> <span id="btnDownloadText">Download .geojson</span>
                </button>
            </div>
        </div>
        
        <!-- Link ArcGIS -->
        <div class="bg-rose-100 p-4 text-center text-sm text-brand-navy border-t border-rose-200">
            <span id="footerText">Setelah download, buka <a href="https://www.arcgis.com/home/webmap/viewer.html" target="_blank" class="font-bold underline hover:text-brand-red">ArcGIS Map Viewer</a> dan tarik file .geojson ke peta.</span>
        </div>

    </div>

    <!-- Modal Info OCR (The Funny Warning) -->
    <div id="ocrInfoModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative border-t-4 border-brand-gold">
            <button onclick="closeOcrInfo()" class="absolute top-4 right-4 text-gray-400 hover:text-brand-red">
                <i class="fa-solid fa-xmark fa-xl"></i>
            </button>
            
            <div class="flex items-center gap-3 mb-4 text-brand-navy">
                <div class="bg-amber-100 p-3 rounded-full">
                    <i class="fa-solid fa-triangle-exclamation text-amber-500 text-xl"></i>
                </div>
                <h3 class="text-xl font-bold">Info OCR "Jadul"</h3>
            </div>
            
            <div class="text-gray-600 text-sm space-y-3">
                <p id="modalText1">
                    ‚ö†Ô∏è <strong>Perhatian:</strong> Fitur Scan di sini menggunakan teknologi browser standar (Tesseract.js) yang bisa dibilang "teknologi jaman old". Dia sering salah baca angka '0' jadi huruf 'O', atau '1' jadi 'l'.
                </p>
                <p id="modalText2" class="bg-rose-50 p-3 rounded-lg border border-rose-100">
                    üí° <strong>Tips Pro:</strong> Jika hasil scan di sini berantakan atau gagal, silakan minta tolong ke <strong>Gemini</strong>, ChatGPT, atau AI canggih lainnya untuk mengekstrak teks dari gambar Anda.
                </p>
                <p id="modalText3">
                    Setelah dapat teks JSON bersih dari AI tersebut, tinggal <strong>Paste</strong> ke kolom input di sini untuk diperbaiki formatnya. Hahaha, harap maklum ya! ‚úåÔ∏è
                </p>
            </div>

            <div class="mt-6 text-right">
                <button onclick="closeOcrInfo()" class="px-4 py-2 bg-brand-navy text-white rounded-lg hover:bg-slate-700 text-sm font-semibold">
                    Siap, Mengerti!
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-brand-navy text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition duration-300 z-50 border-l-4 border-brand-gold">
        Pesan notifikasi
    </div>

    <script>
        // --- MODAL LOGIC ---
        function showOcrInfo() {
            document.getElementById('ocrInfoModal').classList.remove('hidden');
        }
        function closeOcrInfo() {
            document.getElementById('ocrInfoModal').classList.add('hidden');
        }

        // --- TRANSLATION LOGIC ---
        const translations = {
            id: {
                subtitle: "Ubah format GeometryCollection menjadi FeatureCollection (ArcGIS Ready)",
                labelInput: "Data Mentah (Input)",
                btnScan: "Scan Gambar (OCR)",
                btnSample: "Isi Contoh",
                placeholderInput: "Paste kode JSON dari aplikasi Anda di sini...",
                infoText: "Paste teks JSON atau upload screenshot yang berisi kode.",
                labelOutput: "Hasil Perbaikan (ArcGIS Ready)",
                overlayText: "Klik tombol Perbaiki di bawah",
                btnConvert: "Perbaiki untuk ArcGIS",
                btnCopyText: "Salin",
                btnDownloadText: "Unduh .geojson",
                footerText: 'Setelah download, buka <a href="https://www.arcgis.com/home/webmap/viewer.html" target="_blank" class="font-bold underline hover:text-brand-red">ArcGIS Map Viewer</a> dan tarik file .geojson ke peta.',
                ocrStatus: "Membaca gambar...",
                ocrWarning: "Akurasi tergantung kualitas gambar. Cek hasil teksnya nanti.",
                toastEmpty: "‚ö†Ô∏è Input kosong! Silakan paste data atau scan gambar.",
                toastSuccess: "‚úÖ Berhasil diperbaiki! Siap download.",
                toastError: "‚ùå Error: Format JSON tidak valid. Cek kembali text input.",
                toastCopy: "üìã Disalin ke clipboard!",
                toastOCRStart: "üîç Memulai OCR...",
                toastOCRDone: "‚úÖ Scan selesai. Silakan perbaiki typo jika ada.",
                // Modal Texts
                modalTitle: 'Info OCR "Jadul"',
                modalText1: '‚ö†Ô∏è <strong>Perhatian:</strong> Fitur Scan di sini menggunakan teknologi browser standar (Tesseract.js) yang bisa dibilang "teknologi jaman old". Dia sering salah baca angka "0" jadi huruf "O", atau "1" jadi "l".',
                modalText2: 'üí° <strong>Tips Pro:</strong> Jika hasil scan di sini berantakan atau gagal, silakan minta tolong ke <strong>Gemini</strong>, ChatGPT, atau AI canggih lainnya untuk mengekstrak teks dari gambar Anda.',
                modalText3: 'Setelah dapat teks JSON bersih dari AI tersebut, tinggal <strong>Paste</strong> ke kolom input di sini untuk diperbaiki formatnya. Hahaha, harap maklum ya! ‚úåÔ∏è',
                modalBtn: 'Siap, Mengerti!'
            },
            en: {
                subtitle: "Convert GeometryCollection to FeatureCollection (ArcGIS Ready)",
                labelInput: "Raw Data (Input)",
                btnScan: "Scan Image (OCR)",
                btnSample: "Load Sample",
                placeholderInput: "Paste JSON code from your app here...",
                infoText: "Paste JSON text or upload a screenshot containing code.",
                labelOutput: "Fixed Result (ArcGIS Ready)",
                overlayText: "Click Fix button below",
                btnConvert: "Fix for ArcGIS",
                btnCopyText: "Copy",
                btnDownloadText: "Download .geojson",
                footerText: 'After downloading, open <a href="https://www.arcgis.com/home/webmap/viewer.html" target="_blank" class="font-bold underline hover:text-brand-red">ArcGIS Map Viewer</a> and drag the .geojson file onto the map.',
                ocrStatus: "Reading image...",
                ocrWarning: "Accuracy depends on image quality. Please check the text result.",
                toastEmpty: "‚ö†Ô∏è Input empty! Please paste data or scan an image.",
                toastSuccess: "‚úÖ Fixed successfully! Ready to download.",
                toastError: "‚ùå Error: Invalid JSON format. Check input text.",
                toastCopy: "üìã Copied to clipboard!",
                toastOCRStart: "üîç Starting OCR...",
                toastOCRDone: "‚úÖ Scan complete. Please fix any typos.",
                // Modal Texts
                modalTitle: 'Old School OCR Info',
                modalText1: '‚ö†Ô∏è <strong>Warning:</strong> The Scan feature here uses standard browser tech (Tesseract.js) which is basically "old school" tech. It often mistakes "0" for "O", or "1" for "l".',
                modalText2: 'üí° <strong>Pro Tip:</strong> If the scan result is messy or fails, please ask <strong>Gemini</strong>, ChatGPT, or other advanced AIs to extract the text from your image.',
                modalText3: 'Once you get the clean JSON text from the AI, just <strong>Paste</strong> it here to fix the format. Haha, thanks for understanding! ‚úåÔ∏è',
                modalBtn: 'Got it!'
            }
        };

        let currentLang = 'id';

        function setLang(lang) {
            currentLang = lang;
            const t = translations[lang];

            // Update UI Text
            document.getElementById('appSubtitle').innerText = t.subtitle;
            document.getElementById('labelInput').innerText = t.labelInput;
            document.getElementById('btnScan').innerText = t.btnScan;
            document.getElementById('btnSample').innerText = t.btnSample;
            document.getElementById('inputJson').placeholder = t.placeholderInput;
            document.getElementById('infoText').innerText = t.infoText;
            document.getElementById('labelOutput').innerText = t.labelOutput;
            document.getElementById('overlayText').innerText = t.overlayText;
            document.getElementById('btnConvert').innerText = t.btnConvert;
            document.getElementById('btnCopyText').innerText = t.btnCopyText;
            document.getElementById('btnDownloadText').innerText = t.btnDownloadText;
            document.getElementById('footerText').innerHTML = t.footerText;
            document.getElementById('ocrStatus').innerText = t.ocrStatus;
            document.getElementById('ocrWarning').innerText = t.ocrWarning;

            // Modal Update
            document.querySelector('#ocrInfoModal h3').innerText = t.modalTitle;
            document.getElementById('modalText1').innerHTML = t.modalText1;
            document.getElementById('modalText2').innerHTML = t.modalText2;
            document.getElementById('modalText3').innerHTML = t.modalText3;
            document.querySelector('#ocrInfoModal button.bg-brand-navy').innerText = t.modalBtn;

            // Update Buttons Style
            if (lang === 'id') {
                document.getElementById('btn-id').className = "px-3 py-1 rounded text-sm font-bold bg-white text-brand-red transition shadow-sm";
                document.getElementById('btn-en').className = "px-3 py-1 rounded text-sm font-bold text-red-200 hover:text-white transition";
            } else {
                document.getElementById('btn-en').className = "px-3 py-1 rounded text-sm font-bold bg-white text-brand-red transition shadow-sm";
                document.getElementById('btn-id').className = "px-3 py-1 rounded text-sm font-bold text-red-200 hover:text-white transition";
            }
        }

        // --- OCR LOGIC (TESSERACT) ---
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const t = translations[currentLang];
                
                showToast(t.toastOCRStart);
                
                // Show UI
                document.getElementById('ocrProgress').classList.remove('hidden');
                document.getElementById('progressBar').style.width = '0%';

                Tesseract.recognize(
                    file,
                    'eng', 
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                document.getElementById('progressBar').style.width = `${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    document.getElementById('inputJson').value = text;
                    document.getElementById('ocrProgress').classList.add('hidden');
                    showToast(t.toastOCRDone);
                }).catch(err => {
                    console.error(err);
                    document.getElementById('ocrProgress').classList.add('hidden');
                    showToast("‚ùå OCR Error. Coba gambar lain.");
                });
                input.value = '';
            }
        }

        // --- CORE LOGIC ---
        const sampleData = {
            "type": "Feature",
            "properties": { "name": "Youtiao", "type": "Migration" },
            "geometry": {
                "type": "GeometryCollection",
                "geometries": [
                    { "type": "Point", "coordinates": [99.001998, 32.461391] },
                    { "type": "LineString", "coordinates": [[109.90, 35.51], [99.00, 32.46]] },
                    { "type": "Polygon", "coordinates": [[[106.52, 41.50], [113.62, 42.70], [106.52, 41.50]]] } 
                ]
            }
        };

        function loadSample() {
            document.getElementById('inputJson').value = JSON.stringify(sampleData, null, 2);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function convertData() {
            const t = translations[currentLang];
            const inputStr = document.getElementById('inputJson').value;
            
            if (!inputStr.trim()) {
                showToast(t.toastEmpty);
                return;
            }

            try {
                let cleanStr = inputStr
                    .replace(/[\u201C\u201D]/g, '"')
                    .replace(/[\u2018\u2019]/g, "'");

                const inputJson = JSON.parse(cleanStr);
                let features = [];

                if (inputJson.type === "Feature" && inputJson.geometry && inputJson.geometry.type === "GeometryCollection") {
                    const baseProps = inputJson.properties || {};
                    inputJson.geometry.geometries.forEach((geom, index) => {
                        features.push({
                            "type": "Feature",
                            "properties": {
                                ...baseProps,
                                "geometry_type": geom.type
                            },
                            "geometry": geom
                        });
                    });
                } 
                else if (inputJson.type === "GeometryCollection") {
                    inputJson.geometries.forEach(geom => {
                        features.push({
                            "type": "Feature",
                            "properties": {},
                            "geometry": geom
                        });
                    });
                }
                else if (inputJson.type === "FeatureCollection") {
                    features = inputJson.features;
                    showToast("‚ÑπÔ∏è Data (FeatureCollection) OK.");
                } else if (inputJson.type === "Feature") {
                    features = [inputJson];
                } else {
                    throw new Error("Format Unknown");
                }

                const outputGeoJSON = {
                    "type": "FeatureCollection",
                    "features": features
                };

                document.getElementById('outputJson').value = JSON.stringify(outputGeoJSON, null, 2);
                document.getElementById('placeholderOverlay').classList.add('hidden');
                document.getElementById('btnCopy').disabled = false;
                document.getElementById('btnDownload').disabled = false;
                
                showToast(t.toastSuccess);

            } catch (e) {
                console.error(e);
                showToast(t.toastError);
            }
        }

        function copyToClipboard() {
            const t = translations[currentLang];
            const output = document.getElementById('outputJson');
            output.select();
            document.execCommand('copy');
            showToast(t.toastCopy);
        }

        function downloadFile() {
            const text = document.getElementById('outputJson').value;
            const filename = "arcgis_ready_data.geojson";
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    </script>
</body>
</html>
